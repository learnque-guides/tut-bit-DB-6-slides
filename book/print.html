<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">

<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>BIT :: LT :: DB :: 6 presentation :: Additional</title>
    <meta name="robots" content="noindex" />
    <!-- Custom HTML head -->
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff" />

    <link rel="icon" href="favicon.svg">
    <link rel="shortcut icon" href="favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
    <link rel="stylesheet" href="css/print.css" media="print">
    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
    <link rel="stylesheet" href="fonts/fonts.css">
    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
</head>

<body>
    <!-- Provide site root to javascript -->
    <script type="text/javascript">
        var path_to_root = "";
        var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
    </script>

    <!-- Work around some values being stored in localStorage wrapped in quotes -->
    <script type="text/javascript">
        try {
            var theme = localStorage.getItem('mdbook-theme');
            var sidebar = localStorage.getItem('mdbook-sidebar');

            if (theme.startsWith('"') && theme.endsWith('"')) {
                localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
            }

            if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
            }
        } catch (e) { }
    </script>

    <!-- Set the theme before any content is loaded, prevents flash -->
    <script type="text/javascript">
        var theme;
        try { theme = localStorage.getItem('mdbook-theme'); } catch (e) { }
        if (theme === null || theme === undefined) { theme = default_theme; }
        var html = document.querySelector('html');
        html.classList.remove('no-js')
        html.classList.remove('light')
        html.classList.add(theme);
        html.classList.add('js');
    </script>

    <!-- Hide / unhide sidebar before it is displayed -->
    <script type="text/javascript">
        var html = document.querySelector('html');
        var sidebar = 'hidden';
        if (document.body.clientWidth >= 1080) {
            try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch (e) { }
            sidebar = sidebar || 'visible';
        }
        html.classList.remove('sidebar-visible');
        html.classList.add("sidebar-" + sidebar);
    </script>

    <nav id="sidebar" class="sidebar" aria-label="Table of contents">
        <div class="sidebar-scrollbox">
            <ol class="chapter"><li class="chapter-item expanded "><a href="select_into.html"><strong aria-hidden="true">1.</strong> The SELECT INTO statement</a></li><li class="chapter-item expanded "><a href="bulk_insert_statement.html"><strong aria-hidden="true">2.</strong> The BULK INSERT statement</a></li><li class="chapter-item expanded "><a href="merging_data.html"><strong aria-hidden="true">3.</strong> Merging data</a></li><li class="chapter-item expanded "><a href="sequency.html"><strong aria-hidden="true">4.</strong> Sequence</a></li><li class="chapter-item expanded "><a href="modifying_data_through_table_expression.html"><strong aria-hidden="true">5.</strong> Modifying data through table expressions</a></li><li class="chapter-item expanded "><a href="modification_with_top.html"><strong aria-hidden="true">6.</strong> Modifications with TOP and OFFSET-FETCH</a></li><li class="chapter-item expanded "><a href="the_output_clause.html"><strong aria-hidden="true">7.</strong> The OUTPUT clause</a></li><li class="chapter-item expanded "><a href="window_functions.html"><strong aria-hidden="true">8.</strong> Window functions</a></li><li class="chapter-item expanded "><a href="exercise_1.html"><strong aria-hidden="true">9.</strong> Exercise 1</a></li><li class="chapter-item expanded "><a href="exercise_2.html"><strong aria-hidden="true">10.</strong> Exercise 2</a></li><li class="chapter-item expanded "><a href="exercise_3.html"><strong aria-hidden="true">11.</strong> Exercise 3</a></li><li class="chapter-item expanded "><a href="exercise_4.html"><strong aria-hidden="true">12.</strong> Exercise 4</a></li><li class="chapter-item expanded "><a href="exercise_5.html"><strong aria-hidden="true">13.</strong> Exercise 5</a></li><li class="chapter-item expanded "><a href="exercise_6.html"><strong aria-hidden="true">14.</strong> Exercise 6</a></li><li class="chapter-item expanded "><a href="exercise_7.html"><strong aria-hidden="true">15.</strong> Exercise 7</a></li></ol>
        </div>
        <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
    </nav>

    <div id="page-wrapper" class="page-wrapper">
        <div class="page">
            <div id="menu-bar-hover-placeholder"></div>
<header class="page-header">
    <a href="/">
        <img class="page-header-w" src="favicon.svg" alt="Logo">
    </a>
    <h1 class="page-header-text">LearningQueue</h1>
</header>            <div id="menu-bar" class="menu-bar sticky bordered">
                <div class="left-buttons">
                    <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                        <i class="fa fa-bars"></i>
                    </button>
                    <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                        <i class="fa fa-paint-brush"></i>
                    </button>
                    <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                        <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button>
                        </li>
                    </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                        aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                        aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
                </div>

                <h1 class="menu-title">BIT :: LT :: DB :: 6 presentation :: Additional</h1>

                <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                </div>
            </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..."
                        aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>
            <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
            <script type="text/javascript">
                document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                    link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                });
            </script>

            <div id="content" class="content">
                <main>
                    <h1 id="the-select-into-statement"><a class="header" href="#the-select-into-statement">The SELECT INTO statement</a></h1>
<ul>
<li>The SELECT INTO statement is a nonstandard (not a part of ISO and ANSI SQL standart) T-SQL statement that creates a target table and populates it with the result set of a query.</li>
</ul>
<pre><code class="language-sql">SELECT [Column1], [Column2]
    INTO [SchemaName].[ToTableName]
    FROM [SchemaName].[FromTableName];
</code></pre>
<p>Think about SELECT INTO like a <code>copy paste</code></p>
<p>The target table’s structure and data are based on the source table. The SELECT INTO statement copies from the source the base structure (such as column names, types, nullability, and identity property) and the data. It does not copy from the source constraints, indexes, triggers and ect.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-bulk-insert-statement"><a class="header" href="#the-bulk-insert-statement">The BULK INSERT statement</a></h1>
<p>You use the BULK INSERT statement to insert into an existing table data originating from a file. </p>
<pre><code class="language-sql">BULK INSERT [schema].[SourceTable] FROM 'c:\temp\source.txt'
    WITH (
        DATAFILETYPE    = 'char',
        FIELDTERMINATOR = ',',
        ROWTERMINATOR   = '\n'
    );
</code></pre>
<ul>
<li>Create a simple Car table with type column as varchar, number column as varchar</li>
<li>Create file cars.txt with conext like:</li>
</ul>
<pre><code>skoda,rlt111
toyouta,mnt233
honda,mrt123
</code></pre>
<ul>
<li>Upload data to your created table</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="merging-data"><a class="header" href="#merging-data">Merging data</a></h1>
<p>T-SQL supports a statement called MERGE you can use to merge data from a source into a target, applying different actions (INSERT, UPDATE, and DELETE) based on conditional logic. The MERGE statement is part of the SQL standard, although the T-SQL version adds a few nonstandard extensions.</p>
<p>Let's look at example to understand how it works :)</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sequence"><a class="header" href="#sequence">Sequence</a></h1>
<ul>
<li>T-SQL supports the standard sequence object as an alternative key-generating mechanism for identity.</li>
<li>One of the advantages of the sequence object is that, unlike identity, it’s not tied to a particular column in a particular table; rather, it’s an independent object in the database.</li>
</ul>
<pre><code class="language-sql">CREATE SEQUENCE [dbo].[SeqMaxOrderId] AS INT
  MINVALUE 1,
  MAXVALUE 10
  CYCLE; -- Reset to min value after max value reached
</code></pre>
<p>Also supports altering</p>
<pre><code class="language-sql">ALTER SEQUENCE dbo.SeqOrderIDs
  NO CYCLE;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="modifying-data-through-join-and-table-expressions"><a class="header" href="#modifying-data-through-join-and-table-expressions">Modifying data through join and table expressions</a></h1>
<p>Examples:</p>
<pre><code class="language-sql">UPDATE OD
  SET discount += 0.05
FROM dbo.OrderDetails AS OD
  INNER JOIN dbo.Orders AS O
    ON OD.orderid = O.orderid
WHERE O.custid = 1;
</code></pre>
<pre><code class="language-sql">WITH C AS
(
  SELECT custid, OD.orderid,
    productid, discount, discount + 0.05 AS newdiscount
  FROM dbo.OrderDetails AS OD
    INNER JOIN dbo.Orders AS O
      ON OD.orderid = O.orderid
  WHERE O.custid = 1
)
UPDATE C
  SET discount = newdiscount;
</code></pre>
<pre><code class="language-sql">UPDATE D
  SET discount = newdiscount
FROM (SELECT custid, OD.orderid,
        productid, discount, discount + 0.05 AS newdiscount
        FROM dbo.OrderDetails AS OD
        INNER JOIN dbo.Orders AS O
           ON OD.orderid = O.orderid
        WHERE O.custid = 1 ) AS D;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="modifications-with-top-and-offset-fetch"><a class="header" href="#modifications-with-top-and-offset-fetch">Modifications with TOP and OFFSET-FETCH</a></h1>
<ul>
<li>T-SQL supports using the TOP option directly in INSERT, UPDATE, DELETE, and MERGE statements.</li>
<li>The OFFSET-FETCH filter is not allowed directly in modifications because this filter requires an ORDER BY clause and modification statements don’t support one.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-output-clause"><a class="header" href="#the-output-clause">The OUTPUT clause</a></h1>
<p>The OUTPUT clause usefull for debugging when we do INSERT, UPDATE, DELETE and MERGE.</p>
<p>The OUTPUT clause is designed similarly to the SELECT clause, only you need to prefix the attributes with either the inserted or deleted keyword. </p>
<ul>
<li>In an INSERT statement, you refer to inserted; </li>
<li>In a DELETE statement, you refer to deleted; </li>
<li>And in an UPDATE statement, you refer to deleted for the old state of the row and inserted for the new state.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="window-functions"><a class="header" href="#window-functions">Window functions</a></h1>
<p>A window function is a function that, for each row, computes a scalar result value based on a calculation against a subset of the rows from the underlying query.</p>
<pre><code class="language-sql">SELECT empid, ordermonth, val,
  SUM(val) OVER(PARTITION BY empid
                ORDER BY ordermonth) AS runval
FROM Sales.EmpOrders;
</code></pre>
<pre><code class="language-sql">SELECT empid, ordermonth, val, SUM(val), AVG(val)
FROM Sales.EmpOrders
GROUP BY empid, ordermonth, val
ORDER BY ordermonth;
</code></pre>
<p>One of the great advantages of window functions is that they don’t hide the detail. This means you can write expressions that mix detail and aggregates. The next example demonstrates this:</p>
<pre><code class="language-sql">SELECT orderid, custid, val,
  100 * val / SUM(val) OVER() AS pctall,
  100 * val / SUM(val) OVER(PARTITION BY custid) AS pctcust
FROM Sales.OrderValues;
</code></pre>
<p>More details: 
<a href="https://www.sqlshack.com/sql-partition-by-clause-overview/">https://www.sqlshack.com/sql-partition-by-clause-overview/</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-1"><a class="header" href="#exercise-1">Exercise 1</a></h1>
<p>Execute code</p>
<pre><code class="language-sql">DROP TABLE IF EXISTS dbo.Customers;

CREATE TABLE dbo.Customers
(
  custid      INT          NOT NULL PRIMARY KEY,
  companyname NVARCHAR(40) NOT NULL,
  country     NVARCHAR(15) NOT NULL,
  region      NVARCHAR(15) NULL,
  city        NVARCHAR(15) NOT NULL
);
</code></pre>
<p>Insert into the dbo.Customers table a row with the following information:</p>
<ul>
<li>custid: 100</li>
<li>companyname: Coho Winery</li>
<li>country: USA</li>
<li>region: WA</li>
<li>city: Redmond</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-2"><a class="header" href="#exercise-2">Exercise 2</a></h1>
<p>Insert into the dbo.Customers table (you have created it in exercise 1) all customers from Sales.Customers who placed orders.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-3"><a class="header" href="#exercise-3">Exercise 3</a></h1>
<p>Use a SELECT INTO statement to create and populate the dbo.Orders table with orders from the Sales.Orders table that were placed in the years 2014 through 2016.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-4"><a class="header" href="#exercise-4">Exercise 4</a></h1>
<p>Delete from the dbo.Orders table orders that were placed before August 2014. Use the OUTPUT clause to return the orderid and orderdate values of the deleted orders:</p>
<p>Desired output:</p>
<pre><code>orderid     orderdate
----------- -----------
10248       2014-07-04
10249       2014-07-05
10250       2014-07-08
10251       2014-07-08
10252       2014-07-09
10253       2014-07-10
10254       2014-07-11
10255       2014-07-12
10256       2014-07-15
10257       2014-07-16
10258       2014-07-17
10259       2014-07-18
10260       2014-07-19
10261       2014-07-19
10262       2014-07-22
10263       2014-07-23
10264       2014-07-24
10265       2014-07-25
10266       2014-07-26
10267       2014-07-29
10268       2014-07-30
10269       2014-07-31

(22 row(s) affected)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-5"><a class="header" href="#exercise-5">Exercise 5</a></h1>
<p>Delete from the dbo.Orders table orders placed by customers from Brazil.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-6"><a class="header" href="#exercise-6">Exercise 6</a></h1>
<p>Run the following query against dbo.Customers, and notice that some rows have a NULL in the region column:</p>
<pre><code class="language-sql">SELECT * FROM dbo.Customers;
</code></pre>
<p>The output from this query is as follows:</p>
<pre><code class="language-sql">custid      companyname      country         region     city
----------- ---------------- --------------- ---------- ---------------
1           Customer NRZBB   Germany         NULL       Berlin
2           Customer MLTDN   Mexico          NULL       México D.F.
3           Customer KBUDE   Mexico          NULL       México D.F.
4           Customer HFBZG   UK              NULL       London
5           Customer HGVLZ   Sweden          NULL       Luleå
6           Customer XHXJV   Germany         NULL       Mannheim
7           Customer QXVLA   France          NULL       Strasbourg
8           Customer QUHWH   Spain           NULL       Madrid
9           Customer RTXGC   France          NULL       Marseille
10          Customer EEALV   Canada          BC         Tsawassen
...

(90 row(s) affected)
</code></pre>
<p>Update the dbo.Customers table, and change all NULL region values to <None>. Use the OUTPUT clause to show the custid, oldregion, and newregion:</p>
<p>Desired output:</p>
<pre><code>custid      oldregion       newregion
----------- --------------- ---------------
1           NULL            &lt;None&gt;
2           NULL            &lt;None&gt;
3           NULL            &lt;None&gt;
4           NULL            &lt;None&gt;
5           NULL            &lt;None&gt;
6           NULL            &lt;None&gt;
7           NULL            &lt;None&gt;
8           NULL            &lt;None&gt;
9           NULL            &lt;None&gt;
11          NULL            &lt;None&gt;
12          NULL            &lt;None&gt;
13          NULL            &lt;None&gt;
14          NULL            &lt;None&gt;
16          NULL            &lt;None&gt;
17          NULL            &lt;None&gt;
18          NULL            &lt;None&gt;
19          NULL            &lt;None&gt;
20          NULL            &lt;None&gt;
23          NULL            &lt;None&gt;
24          NULL            &lt;None&gt;
25          NULL            &lt;None&gt;
26          NULL            &lt;None&gt;
27          NULL            &lt;None&gt;
28          NULL            &lt;None&gt;
29          NULL            &lt;None&gt;
30          NULL            &lt;None&gt;
39          NULL            &lt;None&gt;
40          NULL            &lt;None&gt;
41          NULL            &lt;None&gt;
44          NULL            &lt;None&gt;
49          NULL            &lt;None&gt;
50          NULL            &lt;None&gt;
52          NULL            &lt;None&gt;
53          NULL            &lt;None&gt;
54          NULL            &lt;None&gt;
56          NULL            &lt;None&gt;
58          NULL            &lt;None&gt;
59          NULL            &lt;None&gt;
60          NULL            &lt;None&gt;
63          NULL            &lt;None&gt;
64          NULL            &lt;None&gt;
66          NULL            &lt;None&gt;
68          NULL            &lt;None&gt;
69          NULL            &lt;None&gt;
70          NULL            &lt;None&gt;
72          NULL            &lt;None&gt;
73          NULL            &lt;None&gt;
74          NULL            &lt;None&gt;
76          NULL            &lt;None&gt;
79          NULL            &lt;None&gt;
80          NULL            &lt;None&gt;
83          NULL            &lt;None&gt;
84          NULL            &lt;None&gt;
85          NULL            &lt;None&gt;
86          NULL            &lt;None&gt;
87          NULL            &lt;None&gt;
90          NULL            &lt;None&gt;
91          NULL            &lt;None&gt;

(58 row(s) affected)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-7"><a class="header" href="#exercise-7">Exercise 7</a></h1>
<p>Update all orders in the dbo.Orders table that were placed by United Kingdom customers, and set their shipcountry, shipregion, and shipcity values to the country, region, and city values of the corresponding customers.</p>

                </main>

                <nav class="nav-wrapper" aria-label="Page navigation">
                    <!-- Mobile navigation buttons -->
                    <div style="clear: both"></div>
                </nav>
            </div>
        </div>

        <nav class="nav-wide-wrapper" aria-label="Page navigation">
        </nav>

    </div>

    <!-- Livereload script (if served using the cli tool) -->
    <script type="text/javascript">
        var socket = new WebSocket("ws://localhost:3000/__livereload");
        socket.onmessage = function (event) {
            if (event.data === "reload") {
                socket.close();
                location.reload();
            }
        };

        window.onbeforeunload = function () {
            socket.close();
        }
    </script>
    <script type="text/javascript">
        window.playground_copyable = true;
    </script>
    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
    <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
    <script src="book.js" type="text/javascript" charset="utf-8"></script>

    <!-- Custom JS scripts -->
    <script type="text/javascript">
        window.addEventListener('load', function () {
            window.setTimeout(window.print, 100);
        });
    </script>
</body>

</html>